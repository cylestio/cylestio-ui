# Task: Implement Alerts API Service

## Context
As part of our migration from direct database access to the REST API, we need to implement the Alerts API service. This service will provide access to security alerts and other warning notifications generated by the monitoring system.

## Requirements

1. Create an Alerts API service module
2. Implement methods for all alerts-related endpoints
3. Support filtering by severity, agent, and time range
4. Implement pagination support

## Detailed Steps

1. Create a new file: `app/lib/api/services/alerts.ts`
2. Implement service methods for:
   - List all alerts with filtering
   - Get alert by ID
   - Mark alerts as reviewed (if supported by API)
3. Add proper TypeScript interfaces for alert data

## Technical Details

The Alerts API service should use our centralized API client to make requests to the following endpoints:

- `GET /v1/alerts` - List alerts with filtering and pagination
- `GET /v1/alerts/{alert_id}` - Get a specific alert
- `PATCH /v1/alerts/{alert_id}` - Update alert status (if supported)

The alerts endpoint supports these filtering parameters:
- `agent_id` - Filter by agent ID
- `severity` - Filter by severity level (low, medium, high, critical)
- `alert_type` - Filter by alert type
- `start_time` - Filter by alerts after this time
- `end_time` - Filter by alerts before this time
- `reviewed` - Filter by review status (true/false)

Here's the expected response structure for the list endpoint:

```json
{
  "items": [
    {
      "id": 1,
      "alert_id": "alert_abc123",
      "event_id": "evt_def456",
      "agent_id": 1,
      "timestamp": "2023-05-11T14:22:30Z",
      "alert_type": "PROMPT_INJECTION",
      "severity": "high",
      "description": "Potential prompt injection attempt detected",
      "metadata": {
        "input_text": "Ignore previous instructions and...",
        "confidence_score": 0.92
      },
      "reviewed": false,
      "reviewed_at": null,
      "reviewed_by": null
    }
  ],
  "total": 1,
  "page": 1,
  "page_size": 50
}
```

## Alert Types and Severity Levels

The system supports various alert types, including:

1. `PROMPT_INJECTION` - Attempts to manipulate the AI system via prompt engineering
2. `SENSITIVE_INFORMATION` - Potential leakage of sensitive information
3. `HARMFUL_CONTENT` - Content that could be harmful or violate policies
4. `ABNORMAL_BEHAVIOR` - Unusual patterns in agent behavior
5. `RESOURCE_ABUSE` - Excessive resource usage

And severity levels:

1. `low` - Informational, minimal risk
2. `medium` - Requires attention but not immediate action
3. `high` - Significant risk, requires prompt attention
4. `critical` - Severe risk, requires immediate action

## Implementation Example

Here's a starting point for the alerts service:

```typescript
import { apiClient } from '../client';
import { Alert, ApiResponse } from '@/app/types/api';

export type AlertSeverity = 'low' | 'medium' | 'high' | 'critical';
export type AlertType = 'PROMPT_INJECTION' | 'SENSITIVE_INFORMATION' | 'HARMFUL_CONTENT' | 'ABNORMAL_BEHAVIOR' | 'RESOURCE_ABUSE';

export interface AlertServiceParams {
  page?: number;
  page_size?: number;
  agent_id?: string;
  severity?: AlertSeverity;
  alert_type?: AlertType;
  start_time?: Date | string;
  end_time?: Date | string;
  reviewed?: boolean;
}

export const alertsService = {
  /**
   * Get a list of alerts with filtering
   */
  async getAll(params: AlertServiceParams = {}): Promise<ApiResponse<Alert>> {
    const response = await apiClient.get('/alerts', { params });
    return response.data;
  },

  /**
   * Get a single alert by ID
   */
  async getById(alertId: string): Promise<Alert> {
    const response = await apiClient.get(`/alerts/${alertId}`);
    return response.data;
  },

  /**
   * Mark an alert as reviewed
   */
  async markAsReviewed(alertId: string, reviewedBy: string): Promise<Alert> {
    const response = await apiClient.patch(`/alerts/${alertId}`, {
      reviewed: true,
      reviewed_by: reviewedBy
    });
    return response.data;
  },
  
  /**
   * Get alerts by agent ID
   */
  async getByAgentId(
    agentId: string,
    params: Omit<AlertServiceParams, 'agent_id'> = {}
  ): Promise<ApiResponse<Alert>> {
    return this.getAll({ ...params, agent_id: agentId });
  },
  
  /**
   * Get alerts by severity
   */
  async getBySeverity(
    severity: AlertSeverity,
    params: Omit<AlertServiceParams, 'severity'> = {}
  ): Promise<ApiResponse<Alert>> {
    return this.getAll({ ...params, severity });
  },
  
  /**
   * Get critical alerts
   */
  async getCritical(params: Omit<AlertServiceParams, 'severity'> = {}): Promise<ApiResponse<Alert>> {
    return this.getBySeverity('critical', params);
  },
  
  /**
   * Get unreviewed alerts
   */
  async getUnreviewed(params: Omit<AlertServiceParams, 'reviewed'> = {}): Promise<ApiResponse<Alert>> {
    return this.getAll({ ...params, reviewed: false });
  }
};
```

## Current Repository Methods To Replace

For reference, here are some key methods from the current `SecurityAlertRepository` class that need to be replaced:

```typescript
// From SecurityAlertRepository
public findBySeverity(severity: string, limit: number = 100): SecurityAlert[]
public findByAgentId(agentId: number, limit: number = 100): SecurityAlert[]
public findByType(alertType: string, limit: number = 100): SecurityAlert[]
public findUnreviewed(limit: number = 100): SecurityAlert[]
public markAsReviewed(id: number, reviewedBy: string): number
```

## Type Definitions

You'll need to define the alert interface in `app/types/api.ts`. Here's a starting point:

```typescript
export type AlertSeverity = 'low' | 'medium' | 'high' | 'critical';
export type AlertType = 'PROMPT_INJECTION' | 'SENSITIVE_INFORMATION' | 'HARMFUL_CONTENT' | 'ABNORMAL_BEHAVIOR' | 'RESOURCE_ABUSE';

export interface Alert {
  id: number;
  alert_id: string;
  event_id: string;
  agent_id: number;
  timestamp: string;
  alert_type: AlertType;
  severity: AlertSeverity;
  description: string;
  metadata: Record<string, any>;
  reviewed: boolean;
  reviewed_at: string | null;
  reviewed_by: string | null;
}
```

## Deliverables

1. Complete implementation of `app/lib/api/services/alerts.ts`
2. Export the service from `app/lib/api/services/index.ts`
3. Define appropriate interfaces in `app/types/api.ts`
4. Include appropriate JSDoc comments for all methods

## References

- API Documentation for alerts endpoints
- TypeScript interfaces in `app/types/api.ts`
- API client in `app/lib/api/client.ts`
- Security Alert Repository implementation for reference 

## Additional contenxt
All migration files and docs, as well as all development phases/prompts (this prompt is only one of them) can be found here in the directory "temp_migration"

## Recommendations from Metrics API Service Implementation

Based on the implementation of the Metrics API Service (Task 7), here are key considerations for the Alerts API Service:

1. **API Path Consistency**: Use `/v1/alerts` for all endpoint paths. The metrics service uses `/v1/metrics/token_usage/total`, etc., so maintain this pattern with the `/v1/` prefix for all API paths.

2. **Parameter Formatting**: Use the `formatRequestParams` helper function for all API calls to ensure proper handling of dates, arrays, and objects:
   ```typescript
   const formattedParams = formatRequestParams(params);
   const response = await apiClient.get('/v1/alerts', { params: formattedParams });
   ```

3. **Date Parsing**: Use the `parseApiDates` helper to convert timestamp strings to Date objects in responses:
   ```typescript
   async getById(alertId: string): Promise<Alert> {
     const response = await apiClient.get(`/v1/alerts/${alertId}`);
     return parseApiDates(response.data, ['timestamp', 'reviewed_at']);
   }
   ```

4. **Test Structure**: When writing tests, use a properly structured mock for the API client:
   ```typescript
   jest.mock('@/lib/api/client');
   
   // In test functions
   (apiClient.get as jest.Mock).mockResolvedValueOnce({ data: mockAlertData });
   ```

5. **Method Chaining**: For specialized methods like `getBySeverity`, ensure they properly delegate to the general `getAll` method:
   ```typescript
   async getBySeverity(severity: AlertSeverity, params: Omit<AlertServiceParams, 'severity'> = {}): Promise<ApiResponse<Alert>> {
     return this.getAll({ ...params, severity });
   }
   ```

6. **Service Naming and Export**: Name the service consistently with others (e.g., `AlertsService` instead of `alertsService` to match `MetricsService` and `EventsService`) and export both the service and its types from the index file.